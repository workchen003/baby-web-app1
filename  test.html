<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Firestore Security Rules Test</title>
    <style>
        body { font-family: sans-serif; padding: 2em; line-height: 1.6; }
        button { font-size: 1em; padding: 0.5em 1em; margin-right: 1em; }
        #log { white-space: pre-wrap; background-color: #f4f4f4; border: 1px solid #ddd; padding: 1em; margin-top: 1em; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Firestore 安全規則測試腳本</h1>
    <p>這個腳本將會隔離地測試對 `records` 集合的查詢權限。</p>
    
    <button id="loginBtn">1. 使用 Google 登入</button>
    <button id="queryBtn" disabled>2. 執行查詢 (請先登入)</button>
    
    <h3>日誌輸出:</h3>
    <div id="log"></div>

    <script type="module">
        // ✅ 步驟 3: 請將此處的 Firebase 設定，替換為您專案的真實設定
        // 您可以從 src/lib/firebase.ts 檔案中找到這些資訊
        const firebaseConfig = {
            apiKey: "AIzaSyDJsvlC8KO4qhs26fY5w5MF0Zu380S-T-g",
            authDomain: "babix-app.firebaseapp.com",
            projectId: "babix-app",
            storageBucket: "babix-app.firebasestorage.app",
            messagingSenderId: "116398044223",
            appId: "1:116398044223:web:0ea570fb78e8c18f30f48a"
        };

        // --- 以下程式碼請勿修改 ---
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginBtn = document.getElementById('loginBtn');
        const queryBtn = document.getElementById('queryBtn');
        const logDiv = document.getElementById('log');

        let currentUser = null;
        let userFamilyId = null; // 在這裡手動設定

        function log(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            p.className = type;
            logDiv.appendChild(p);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                log(`使用者已登入: ${user.email} (UID: ${user.uid})`, 'success');
                loginBtn.textContent = '已登入';
                loginBtn.disabled = true;
                queryBtn.disabled = false;
            } else {
                currentUser = null;
                loginBtn.textContent = '1. 使用 Google 登入';
                loginBtn.disabled = false;
                queryBtn.disabled = true;
            }
        });

        loginBtn.addEventListener('click', async () => {
            try {
                log('正在啟動 Google 登入...');
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                log(`登入失敗: ${error.message}`, 'error');
            }
        });

        queryBtn.addEventListener('click', async () => {
            if (!currentUser) {
                log('錯誤：使用者未登入。', 'error');
                return;
            }
            
            // ✅ 步驟 4: 請手動填入您要測試的 familyId
            // 請從您的 Firestore "families" 集合中，複製一個真實的 familyId
            userFamilyId = "6c943001-1942-41d8-a957-a1765b75214c"; // <--- 請務必填寫這裡

            if (!userFamilyId) {
                log('錯誤：請在腳本中填寫要測試的 familyId。', 'error');
                return;
            }
            
            log(`準備執行查詢：在 'records' 集合中尋找 familyId 為 '${userFamilyId}' 的文件...`);

            try {
                const recordsRef = collection(db, 'records');
                const q = query(recordsRef, where("familyId", "==", userFamilyId));
                
                const querySnapshot = await getDocs(q);
                
                log(`查詢成功！找到了 ${querySnapshot.size} 筆文件。`, 'success');
                querySnapshot.forEach(doc => {
                    log(`  - 文件 ID: ${doc.id}, 資料: ${JSON.stringify(doc.data())}`);
                });

            } catch (error) {
                log(`查詢失敗！錯誤訊息: ${error.message}`, 'error');
                console.error("完整的錯誤物件:", error);
            }
        });
    </script>
</body>
</html>